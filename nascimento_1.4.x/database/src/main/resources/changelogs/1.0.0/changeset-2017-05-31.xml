<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-1">
		<dropNotNullConstraint tableName="parent"
			columnName="academic_degree" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-2">
		<dropNotNullConstraint tableName="parent"
			columnName="date_of_birth" columnDataType="date" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-3">
		<dropNotNullConstraint tableName="parent"
			columnName="email" columnDataType="varchar(150)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-4">
		<dropNotNullConstraint tableName="parent"
			columnName="family_name" columnDataType="varchar(150)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-5">
		<dropNotNullConstraint tableName="parent"
			columnName="gender" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-6">
		<dropNotNullConstraint tableName="parent"
			columnName="given_name" columnDataType="varchar(150)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-7">
		<dropNotNullConstraint tableName="parent"
			columnName="identification_card_number" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-8">
		<dropNotNullConstraint tableName="parent"
			columnName="identification_card_type" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-9">
		<dropNotNullConstraint tableName="parent"
			columnName="job" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-10">
		<dropNotNullConstraint tableName="parent"
			columnName="job_condition" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-11">
		<dropNotNullConstraint tableName="parent"
			columnName="job_status" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-12">
		<dropNotNullConstraint tableName="parent"
			columnName="marital_status" columnDataType="varchar(75)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-13">
		<dropNotNullConstraint tableName="parent"
			columnName="key_nationality" columnDataType="bigint(20)" />
	</changeSet>
	<changeSet author="pzenida"
		id="2017-05-31-allow-nulls-for-parent-columns-14">
		<dropNotNullConstraint tableName="parent"
			columnName="key_naturality" columnDataType="bigint(20)" />
	</changeSet>

	<changeSet author="pzenida"
		id="2017-05-31-insert-second-parent-birth-registration-confirmation-url-message-template">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
                                <![CDATA[
select count(*) from message_template where code = 'EMAIL_001'
                                ]]>
			</sqlCheck>
		</preConditions>
		<insert tableName="table_hilo_generator">
			<column name="table_name" value="message_template" />
			<column name="next_val" value="101" />
		</insert>
		<sql>
			<![CDATA[
insert into message_template (id, creation_date, code, type, subject, content)
values (1, CURRENT_TIMESTAMP(), 'EMAIL_001', 'EMAIL', 'Nascimento online - confirmação de registo de nascimento',
'<p>Olá.</p>
<p>Antes de mais, gostaríamos de dar-lhe os parabéns pelo nascimento do seu bebé: ${birthRegistration.name}!</p>
<p>Para concluir o pedido de registo de nascimento online que foi registado pelo 1.º progenitor, ${birthRegistration.firstParent.name}, clique por favor no endereço apresentado 
abaixo, começando a validação do pedido pela sua identificação com o cartão de cidadão e, após verificar a veracidade dos dados registados, no separador "Resumo", 
deverá escolher a opção Aceitar.</p>
<p><a href="http://localhost:8080/nascimento/index.xhtml?id=${birthRegistration.id}">VALIDAR PEDIDO</a></p>')
			]]>
		</sql>
		<rollback>
			<sql>
				<![CDATA[
delete from table_hilo_generator where table_name = 'message_template'
				]]>
			</sql>
			<sql>
				<![CDATA[
delete from message_template where code = 'EMAIL_001'
                ]]>
			</sql>
		</rollback>
	</changeSet>

	<changeSet author="pzenida" id="2017-05-31-add-email-to-organization">
		<addColumn tableName="organization">
			<column name="email" type="VARCHAR(150)" />
		</addColumn>
	</changeSet>

	<changeSet author="pzenida" id="2017-05-31-update-message-template">
		<sql>
			<![CDATA[
update message_template set subject = 'Nascimento online - confirmação de registo de nascimento',
content = 
'<p>Olá.</p>
<p>Antes de mais, gostaríamos de dar-lhe os parabéns pelo nascimento do seu bebé: ${birthRegistration.name}!</p>
<p>Para concluir o pedido de registo de nascimento online que foi registado pelo 1.º progenitor, ${birthRegistration.firstParent.name}, clique por favor no endereço apresentado 
abaixo, começando a validação do pedido pela sua identificação com o cartão de cidadão e, após verificar a veracidade dos dados registados, no separador "Resumo", 
deverá escolher a opção Aceitar.</p>
<p><a href="http://localhost:8080/nascimento/index.xhtml?uuid=${birthRegistration.uuid}">VALIDAR PEDIDO</a></p>' where code = 'EMAIL_001'
			]]>
		</sql>
		<rollback />
	</changeSet>

	<changeSet author="pzenida" id="2017-05-31-change-code-on-country">
		<renameColumn tableName="country" oldColumnName="code"
			newColumnName="code" columnDataType="varchar(3)" />
	</changeSet>

</databaseChangeLog>