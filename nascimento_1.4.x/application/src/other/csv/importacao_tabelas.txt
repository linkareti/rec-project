== CRIAR TABELAS ==
CREATE TABLE DISTRITOS (CODIGO VARCHAR(10), NOME VARCHAR(255), INICIO DATE, FIM DATE);
CREATE TABLE CONCELHOS (COD_DISTRITO VARCHAR(10), CODIGO VARCHAR(10), NOME VARCHAR(255), INICIO DATE, FIM DATE);
CREATE TABLE FREGUESIAS (COD_DISTRITO VARCHAR(10), COD_CONCELHO VARCHAR(10), CODIGO VARCHAR(10), NOME VARCHAR(255), INICIO DATE, FIM DATE);

== COPIAR FICHEIROS PARA IMPORTAR PARA /var/lib/mysql/nascimento ==
(como root)
cp /home/pzenida/Desktop/nascimento/freguesias/concelhos_to_import_for_table.csv .
cp /home/pzenida/Desktop/nascimento/freguesias/distritos_to_import_for_table.csv .
cp /home/pzenida/Desktop/nascimento/freguesias/freguesias_to_import_for_table.csv .

E retirar os cabeçalhos

== IMPORTAÇÃO DOS DADOS PARA AS TABELAS ==
Exportação das sheets para CSV com formato normal, eliminação da primeira coluna, e cópia para /var/lib/mysql/nascimento

Em seguida:

load data infile 'distritos_to_import_for_table.csv' into table nascimento.DISTRITOS character set 'utf8' fields terminated by ';' enclosed by '"'; 

load data infile 'concelhos_to_import_for_table.csv' into table nascimento.CONCELHOS character set 'utf8' fields terminated by ';' enclosed by '"';

load data infile 'freguesias_to_import_for_table.csv' into table nascimento.FREGUESIAS character set 'utf8' fields terminated by ';' enclosed by '"';

== CRIAÇÃO DE AUTO INCREMENT COLUMN PARA TERMOS PK ==

ALTER TABLE DISTRITOS ADD COLUMN NUMERO INT(11) AUTO_INCREMENT PRIMARY KEY;
ALTER TABLE CONCELHOS ADD COLUMN NUMERO INT(11) AUTO_INCREMENT PRIMARY KEY;
ALTER TABLE FREGUESIAS ADD COLUMN NUMERO INT(11) AUTO_INCREMENT PRIMARY KEY;

== CRIAÇÃO DE COLUNA COM EXTERNAL ID ==
ALTER TABLE DISTRITOS ADD COLUMN ID_EXTERNO VARCHAR (20);
ALTER TABLE CONCELHOS ADD COLUMN ID_EXTERNO VARCHAR (20);
ALTER TABLE FREGUESIAS ADD COLUMN ID_EXTERNO VARCHAR (20);

UPDATE DISTRITOS SET ID_EXTERNO = CONCAT(CODIGO, '_', NUMERO);
UPDATE CONCELHOS SET ID_EXTERNO = CONCAT(CODIGO, '_', NUMERO);
UPDATE FREGUESIAS SET ID_EXTERNO = CONCAT(CODIGO, '_', NUMERO);

== CRIAÇÃO DE INDEXES ==

CREATE INDEX IDX_COD_DISTRITO ON FREGUESIAS (COD_DISTRITO);
CREATE INDEX IDX_COD_CONCELHO ON FREGUESIAS (COD_CONCELHO);
CREATE INDEX IDX_CODIGO ON FREGUESIAS (CODIGO);
CREATE INDEX IDX_ID_EXTERNO ON FREGUESIAS (ID_EXTERNO);

CREATE INDEX IDX_COD_DISTRITO ON CONCELHOS (COD_DISTRITO);
CREATE INDEX IDX_CODIGO ON CONCELHOS (CODIGO);
CREATE INDEX IDX_ID_EXTERNO ON CONCELHOS (ID_EXTERNO);

CREATE INDEX IDX_CODIGO ON DISTRITOS (CODIGO);
CREATE INDEX IDX_ID_EXTERNO ON DISTRITOS (ID_EXTERNO);

== ADIÇÃO DE COLUNAS REFERENCIAIS DE ID_EXTERNO ==

1 - Concelhos
ALTER TABLE CONCELHOS ADD COLUMN ID_EXTERNO_DISTRITO VARCHAR (40);
UPDATE CONCELHOS C INNER JOIN DISTRITOS D ON C.COD_DISTRITO = D.CODIGO SET ID_EXTERNO_DISTRITO = D.ID_EXTERNO WHERE (D.INICIO BETWEEN C.INICIO AND C.FIM OR D.FIM BETWEEN C.INICIO AND C.FIM OR C.INICIO BETWEEN D.INICIO AND D.FIM OR C.FIM BETWEEN D.INICIO AND D.FIM);

2 - Freguesias
ALTER TABLE FREGUESIAS ADD COLUMN ID_EXTERNO_CONCELHO VARCHAR (40);
UPDATE FREGUESIAS F INNER JOIN CONCELHOS C ON F.COD_CONCELHO = C.CODIGO SET ID_EXTERNO_CONCELHO = C.ID_EXTERNO WHERE (C.INICIO BETWEEN F.INICIO AND F.FIM OR C.FIM BETWEEN F.INICIO AND F.FIM OR F.INICIO BETWEEN C.INICIO AND C.FIM OR F.FIM BETWEEN C.INICIO AND C.FIM);

ALTER TABLE FREGUESIAS ADD COLUMN ID_EXTERNO_DISTRITO VARCHAR (40);
UPDATE FREGUESIAS F INNER JOIN CONCELHOS C ON F.COD_CONCELHO = C.CODIGO SET F.ID_EXTERNO_DISTRITO = C.ID_EXTERNO_DISTRITO WHERE (C.INICIO BETWEEN F.INICIO AND F.FIM OR C.FIM BETWEEN F.INICIO AND F.FIM OR F.INICIO BETWEEN C.INICIO AND C.FIM OR F.FIM BETWEEN C.INICIO AND C.FIM);

== INDEXES ADICIONAIS ==
CREATE INDEX IDX_ID_EXTERNO_DISTRITO ON CONCELHOS (ID_EXTERNO_DISTRITO);

== EXPORTAÇÃO DE DADOS PARA CSVs FINAIS ==

1 - Exportar distritos:
SELECT ID_EXTERNO as externalId, NOME as name, CODIGO AS code, CASE WHEN FIM > '2017-07-01' THEN 'true' ELSE 'false' END as active, 'PRT' as countryExternalId FROM DISTRITOS INTO OUTFILE '/tmp/districts.csv' CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\n';

Editar o ficheiro, e adicionar o cabeçalho:
"externalId";"name";"code";"active";"countryExternalId"

2 - Exportar concelhos:
CREATE TEMPORARY TABLE X AS SELECT C.ID_EXTERNO as externalId, C.NOME as name, C.CODIGO AS code, CASE WHEN C.FIM > '2017-07-01' THEN 'true' ELSE 'false' END as active, C.ID_EXTERNO_DISTRITO as districtExternalId FROM CONCELHOS C WHERE C.ID_EXTERNO_DISTRITO IS NOT NULL ORDER BY C.CODIGO, C.FIM DESC;
SELECT CONCAT(X.districtExternalId, '_', X.externalId) as externalId, X.name, X.code, X.active, X.districtExternalId  FROM X INNER JOIN DISTRITOS ON DISTRITOS.ID_EXTERNO = X.districtExternalId GROUP BY X.externalId, X.NAME, DISTRITOS.NOME INTO OUTFILE '/tmp/counties.csv' CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\n';
DROP TABLE X;

Editar o ficheiro, e adicionar o cabeçalho:
"externalId";"name";"code";"active";"districtExternalId"

3 - Exportar freguesias:
CREATE TEMPORARY TABLE X AS SELECT F.ID_EXTERNO as externalId, F.NOME as name, F.CODIGO as code, CASE WHEN F.FIM > '2017-07-01' THEN 'true' ELSE 'false' END as active, F.ID_EXTERNO_CONCELHO as countyExternalId, F.ID_EXTERNO_DISTRITO AS districtExternalId FROM FREGUESIAS F WHERE F.ID_EXTERNO_CONCELHO IS NOT NULL ORDER BY F.FIM DESC;
SELECT CONCAT(X.districtExternalId, '_', X.countyExternalId, X.externalId) as externalId, X.name, X.code, X.active, CONCAT(X.districtExternalId, '_', X.countyExternalId) as countyExternalId FROM X inner join CONCELHOS ON CONCELHOS.ID_EXTERNO = X.countyExternalId INNER JOIN DISTRITOS ON DISTRITOS.ID_EXTERNO = X.districtExternalId GROUP BY X.NAME, CONCELHOS.NOME, DISTRITOS.NOME INTO OUTFILE '/tmp/parishes.csv' CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\n';
DROP TABLE X;

Editar o ficheiro e adicionar o cabeçalho:
"externalId";"name";"code";"active";"countyExternalId"
